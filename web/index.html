<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="LithoMaker - Create 3D lithophanes from images directly in your browser. No upload, no server - all processing happens locally.">
    <title>LithoMaker - Browser Lithophane Generator</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        /* Loading screen styles */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .loading-content {
            text-align: center;
            padding: 2rem;
        }

        .loading-content h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .loading-content p {
            opacity: 0.8;
            margin-bottom: 1.5rem;
        }

        .progress-container {
            width: 300px;
            margin: 1rem auto;
        }

        progress {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            appearance: none;
        }

        progress::-webkit-progress-bar {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        progress::-webkit-progress-value {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
        }

        #progress-text {
            display: block;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .privacy-note {
            font-size: 0.85rem;
            opacity: 0.7;
            margin-top: 2rem;
        }

        #error-message {
            color: #ff6b6b;
            margin-top: 1rem;
            display: none;
        }

        /* Qt container */
        #qt-container {
            width: 100%;
            height: 100vh;
            display: none;
        }
    </style>
</head>

<body>
    <!-- Loading Screen -->
    <div id="loading">
        <div class="loading-content">
            <h1>üñºÔ∏è LithoMaker</h1>
            <p>Create 3D lithophanes from your images</p>
            <div class="progress-container">
                <progress id="progress" value="0" max="100"></progress>
                <span id="progress-text">Loading WebAssembly...</span>
            </div>
            <p class="privacy-note">
                üîí All processing happens in your browser.<br>
                Your images never leave your device.
            </p>
            <p id="error-message"></p>
        </div>
    </div>

    <!-- Qt WASM Application Container -->
    <div id="qt-container"></div>

    <!-- Qt WASM Loader Scripts -->
    <script src="qtloader.js"></script>
    <script src="LithoMaker.js"></script>
    <script>
        (async function () {
            const loadingDiv = document.getElementById('loading');
            const progressBar = document.getElementById('progress');
            const progressText = document.getElementById('progress-text');
            const errorMessage = document.getElementById('error-message');
            const qtContainer = document.getElementById('qt-container');

            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
                progressText.textContent = 'Error loading application';
            }

            function updateProgress(loaded, total) {
                if (total > 0) {
                    const percent = Math.round((loaded / total) * 100);
                    progressBar.value = percent;
                    progressText.textContent = `Loading... ${percent}% (${(loaded / 1024 / 1024).toFixed(1)} MB)`;
                }
            }

            try {
                // Qt 6 WASM loading using qtLoad()
                const instance = await qtLoad({
                    // Emscripten configuration
                    locateFile: (path) => path,

                    // Progress callback
                    setStatus: (status) => {
                        if (status) {
                            const match = status.match(/([^(]+)\((\d+)\/(\d+)\)/);
                            if (match) {
                                updateProgress(parseInt(match[2]), parseInt(match[3]));
                            } else {
                                progressText.textContent = status;
                            }
                        }
                    },

                    // Qt-specific configuration
                    qt: {
                        containerElements: [qtContainer],

                        onLoaded: () => {
                            console.log('Qt application loaded successfully');
                            loadingDiv.style.display = 'none';
                            qtContainer.style.display = 'block';
                        },

                        onExit: (exitData) => {
                            console.log('Qt application exited', exitData);
                            if (exitData.code !== 0) {
                                showError(`Application exited with code ${exitData.code}`);
                            }
                        }
                    }
                });

                console.log('Qt WASM instance created:', instance);

            } catch (error) {
                console.error('Failed to load Qt application:', error);
                showError(`Failed to load: ${error.message}`);
            }
        })();
    </script>
</body>

</html>