name: Build WASM and Deploy to Pages

on:
  push:
    branches: [main, master]
    tags: ['v*']
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  QT_VERSION: '6.5.3'
  # IMPORTANT: This must match Qt's required Emscripten version
  # Qt 6.5.x requires Emscripten 3.1.25
  EMSDK_VERSION: '3.1.25'

# Sets permissions for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-wasm:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Emscripten
      run: |
        git clone https://github.com/emscripten-core/emsdk.git
        cd emsdk
        # CRITICAL: Must use exact version that Qt 6.5.3 was built with
        ./emsdk install 3.1.25
        ./emsdk activate 3.1.25
        source ./emsdk_env.sh
        echo "EMSDK=$PWD" >> $GITHUB_ENV
        echo "$PWD" >> $GITHUB_PATH
        echo "$PWD/upstream/emscripten" >> $GITHUB_PATH

    - name: Verify Emscripten
      run: |
        source emsdk/emsdk_env.sh
        emcc --version
        em++ --version

    - name: Install Qt6 Host (Linux)
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ env.QT_VERSION }}
        host: 'linux'
        target: 'desktop'
        arch: 'gcc_64'
        cache: true
        set-env: true

    - name: Install Qt6 WASM Architecture
      run: |
        pip install aqtinstall
        QT_INSTALL_DIR="${RUNNER_TEMP}/qt-wasm"
        aqt install-qt linux desktop ${{ env.QT_VERSION }} wasm_singlethread \
          --outputdir "$QT_INSTALL_DIR"
        chmod +x "$QT_INSTALL_DIR/${{ env.QT_VERSION }}/wasm_singlethread/bin/"* || true
        echo "QT_WASM_DIR=$QT_INSTALL_DIR/${{ env.QT_VERSION }}/wasm_singlethread" >> $GITHUB_ENV

    - name: Configure CMake for WASM
      run: |
        source emsdk/emsdk_env.sh
        mkdir build && cd build
        $QT_WASM_DIR/bin/qt-cmake .. \
          -DBUILD_WASM=ON \
          -DCMAKE_BUILD_TYPE=Release \
          -DQT_HOST_PATH=$Qt6_DIR

    - name: Build
      run: |
        source emsdk/emsdk_env.sh
        cmake --build build --parallel $(nproc)
        
        # Debug: Show what was generated
        echo "=== Build directory contents ==="
        ls -la build/
        echo "=== Find all generated files ==="
        find build -name "*.html" -o -name "*.wasm" -o -name "*.js" | head -50

    - name: Prepare deployment files
      run: |
        mkdir -p deploy
        
        # Find and copy all WASM-related files
        find build -name "*.html" -exec cp {} deploy/ \;
        find build -name "*.wasm" -exec cp {} deploy/ \;
        find build -name "*.js" -exec cp {} deploy/ \;
        
        # Copy our custom styles
        cp web/style.css deploy/
        cp default.png deploy/favicon.png 2>/dev/null || true
        
        # Create index.html if the Qt-generated one exists
        if [ -f deploy/LithoMaker.html ]; then
          mv deploy/LithoMaker.html deploy/index.html
        fi
        
        # Check if we have the essential files
        echo "=== Deployment files ==="
        ls -la deploy/
        
        if [ ! -f deploy/*.wasm ]; then
          echo "ERROR: No WASM files found!"
          echo "Build may have failed silently. Check above for errors."
          exit 1
        fi

    - name: Upload WASM artifact
      uses: actions/upload-artifact@v4
      with:
        name: LithoMaker-WASM
        path: deploy/
        retention-days: 30

  deploy-pages:
    needs: build-wasm
    runs-on: ubuntu-latest
    # Only deploy on main branch or tags, not PRs
    if: github.event_name != 'pull_request'
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Download WASM artifact
      uses: actions/download-artifact@v4
      with:
        name: LithoMaker-WASM
        path: ./deploy

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Upload to GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./deploy

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
